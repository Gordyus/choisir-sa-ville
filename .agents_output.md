## Map Enhancements Report

### Scope

- apps/web/lib/config/mapTilesConfig.ts
- apps/web/public/config/map-tiles.json
- apps/web/lib/map/mapStyle.ts
- apps/web/lib/map/mapInteractionService.ts
- apps/web/lib/map/interactiveLayers.ts (supporting exports already merged)
- apps/web/lib/map/cityInteractiveLayer.ts (shared helpers already aligned)

### Key Deliverables

1. **Config schema upgrade** – `mapTilesConfig` now normalizes `tileJsonSources`, `polygonSources`, and `cityClasses`, exposing them through `AppConfig`. The public `map-tiles.json` file switched to the new keys (`vectorTilesBaseUrl`, `styleUrl`, `excludeLayers`, `polygonSources`, etc.) so runtime no longer falls back to defaults.
2. **Managed label filters** – `mapStyle` seeds `setPlaceClassList` with `cityClasses`, builds include/exclude filters once, and reuses them for both the managed symbol layers and the invisible hitbox circles managed by `cityInteractiveLayer`.
3. **Polygon styling** – Commune and arrondissement sources derive from configurable TileJSON endpoints. Their fill/line paints now combine hover + selected `feature-state` transitions (colors: base `#0f172a`, hover `#2d5bff`/`#38bdf8`, selected `#f59e0b`) with zoom-aware linewidth ramps.
4. **Feature-state orchestration** – `mapInteractionService` queries the polygon layers on every hover/click, resolves INSEE via polygons before falling back to OSM/Wikidata, and keeps polygon `selected` state in sync with label clicks. Hover state still comes from direct polygon `mousemove` handlers but now reuses the generalized `setPolygonFeatureState` helper.

### Manual Test Checklist

1. Start the tileserver that publishes `/data/{france,communes,arr_municipal}.json` plus the `/styles/basic-preview/style.json` endpoint, then run `pnpm -C apps/web dev`.
2. Load the map, zoom between 9–14:
   - Communes: faint fill at rest, brighter blue on hover, amber on selection; outlines widen smoothly with zoom.
   - Arrondissements: only from zoom ≥11 with their own cyan palette.
3. Hover polygon fills directly to ensure `feature-state.hover` animates fill opacity and stroke width, then move away to confirm cleanup (no stuck highlights).
4. Hover/click city/town/village labels. Even if the tile lacks `insee`, clicks should now resolve via the polygon beneath the cursor; check the console for `[map-interaction] Unable to resolve INSEE` (should be rare).
5. Click multiple cities in a row and verify only the latest polygon stays highlighted (selected outline + amber fill). Clicking empty space should clear polygon selection.
6. Watch the console for `source-layer missing` or `Failed to toggle polygon state` warnings—there should be none with the default config.

### Operational Notes

- TileJSON endpoints must expose the commune/arrondissement source layers listed in `map-tiles.json`; otherwise `injectAdministrativeSourcesAndLayers` skips them with a warning.
- Polygon layers depend on `insee` inside the vector tiles. When generating tiles without `--generate-ids`, the `promoteId` fallback still keeps hover/selection stable.
- `cityClasses` is configurable via `map-tiles.json`; missing or empty arrays fall back to `["city","town","village"]`.
