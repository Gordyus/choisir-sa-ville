# SQUASH REFACTORING – Selection & Entity State Architecture

## 1. Final Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              DOMAIN LAYER                                   │
│                         (No UI/MapLibre deps)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────┐       ┌────────────────────────────────┐          │
│  │    EntityRef        │       │    SelectionService            │          │
│  │  (commune|infraZone)│◄──────│  - state: normal/highlight/    │          │
│  └─────────────────────┘       │           active               │          │
│                                │  - single-select (multi-ready) │          │
│                                │  - listeners                   │          │
│                                └────────────────────────────────┘          │
│                                            │                               │
│  ┌─────────────────────────────────────────┼───────────────────────────┐   │
│  │                                         ▼                           │   │
│  │  ┌────────────────────────────────────────────────────────────┐    │   │
│  │  │              EntityDataProvider (interface)                │    │   │
│  │  │  - getCommune(ref): Promise<CommuneData>                   │    │   │
│  │  │  - getInfraZone(ref): Promise<InfraZoneData>               │    │   │
│  │  │  - hasEntity(ref): Promise<boolean>                        │    │   │
│  │  └────────────────────────────────────────────────────────────┘    │   │
│  │                        ▲                                           │   │
│  │                        │                                           │   │
│  │  ┌─────────────────────┴────────────────────────────────────┐     │   │
│  │  │         CachedEntityDataProvider (decorator)             │     │   │
│  │  │  - IndexedDB cache (7-day TTL)                           │     │   │
│  │  └──────────────────────┬───────────────────────────────────┘     │   │
│  │                         ▼                                         │   │
│  │  ┌──────────────────────────────────────────────────────────┐    │   │
│  │  │       StaticFilesEntityDataProvider (concrete)           │    │   │
│  │  │  - reads from /data/{version}/...                        │    │   │
│  │  └──────────────────────────────────────────────────────────┘    │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
            ┌─────────────────────────┼─────────────────────────┐
            │                         │                         │
            ▼                         ▼                         ▼
┌───────────────────────┐   ┌─────────────────┐   ┌───────────────────────┐
│     Map Adapter       │   │  Right Panel    │   │  Future: Search,      │
│  - consumes selection │   │  - consumes     │   │  URL state, etc.      │
│  - produces highlight/│   │    selection    │   │                       │
│    active events      │   │  - fetches data │   │                       │
│  - applies feature-   │   │    via provider │   │                       │
│    state to labels    │   │  - NO map deps  │   │                       │
└───────────────────────┘   └─────────────────┘   └───────────────────────┘
```

### Key Decoupling Rules

1. **Map adapter** depends on: `SelectionService`, spatial indexes (for resolution)
2. **Right panel** depends on: `SelectionService`, `EntityDataProvider`
3. **Neither** depends on the other
4. **SelectionService** has **no** MapLibre or React dependencies

---

## 2. Public API – Selection Service

```typescript
// lib/selection/types.ts

/** Entity reference – the canonical way to identify an entity */
export type EntityRef =
  | { kind: "commune"; inseeCode: string }
  | { kind: "infraZone"; id: string };

/** Visual state of an entity (UI-agnostic) */
export type EntityVisualState = "normal" | "highlight" | "active";

/** Selection state snapshot */
export type SelectionState = {
  /** Currently highlighted entity (hover, focus, etc.) */
  highlighted: EntityRef | null;
  /** Currently active entity (selected) */
  active: EntityRef | null;
};

/** Events emitted by the selection service */
export type SelectionEvent =
  | { type: "highlight"; entity: EntityRef | null; previous: EntityRef | null }
  | { type: "active"; entity: EntityRef | null; previous: EntityRef | null };

export type SelectionListener = (event: SelectionEvent) => void;
```

```typescript
// lib/selection/selectionService.ts

export interface SelectionService {
  /** Get current state snapshot */
  getState(): SelectionState;

  /** Set highlighted entity (null to clear) */
  setHighlighted(entity: EntityRef | null): void;

  /** Set active entity (null to clear) */
  setActive(entity: EntityRef | null): void;

  /** Clear all selection state */
  clearAll(): void;

  /** Subscribe to state changes */
  subscribe(listener: SelectionListener): () => void;

  /** Check if an entity matches the current active selection */
  isActive(entity: EntityRef): boolean;

  /** Check if an entity matches the current highlighted selection */
  isHighlighted(entity: EntityRef): boolean;
}

/** Create a new selection service instance (singleton pattern recommended) */
export function createSelectionService(): SelectionService;
```

---

## 3. Public API – Entity Data Provider

```typescript
// lib/data/types.ts

export type CommuneData = {
  inseeCode: string;
  name: string;
  departmentCode: string;
  regionCode: string;
  lat: number;
  lon: number;
  population: number | null;
};

export type InfraZoneData = {
  id: string;
  type: string;
  code: string;
  parentCommuneCode: string;
  name: string;
  lat: number;
  lon: number;
  population: number | null;
};

export type EntityData =
  | { kind: "commune"; data: CommuneData }
  | { kind: "infraZone"; data: InfraZoneData };
```

```typescript
// lib/data/entityDataProvider.ts

export interface EntityDataProvider {
  /** Get commune data by INSEE code */
  getCommune(inseeCode: string, signal?: AbortSignal): Promise<CommuneData | null>;

  /** Get infra-zone data by ID */
  getInfraZone(id: string, signal?: AbortSignal): Promise<InfraZoneData | null>;

  /** Get entity data by reference */
  getEntity(ref: EntityRef, signal?: AbortSignal): Promise<EntityData | null>;

  /** Check if entity exists in data source */
  hasEntity(ref: EntityRef, signal?: AbortSignal): Promise<boolean>;

  /** Get parent commune for an infra-zone */
  getParentCommune(infraZoneId: string, signal?: AbortSignal): Promise<CommuneData | null>;
}
```

```typescript
// lib/data/cache/cachedEntityDataProvider.ts

export interface CacheConfig {
  /** Cache TTL in milliseconds (default: 7 days) */
  ttlMs?: number;
  /** Database name for IndexedDB */
  dbName?: string;
}

/** Create a caching wrapper around any EntityDataProvider */
export function createCachedEntityDataProvider(
  provider: EntityDataProvider,
  config?: CacheConfig
): EntityDataProvider;
```

---

## 4. Map Label States → Feature-State Mapping

### State Model (from `map-label-state-system.md`)

| Product State | Feature-State Flags | Visual Meaning |
|---------------|---------------------|----------------|
| default | none | Standard OSM label |
| known entity | `hasData=true` | Entity in product database |
| highlighted | `hasData=true, highlight=true` | Focus/hover emphasis |
| active | `hasData=true, active=true` | Selected entity |

### Priority (in style expressions)
```
active > highlight > hasData > default
```

### Feature-State Application

```typescript
// Map adapter sets feature-state based on SelectionService events

function onSelectionEvent(event: SelectionEvent): void {
  if (event.type === "highlight") {
    // Clear previous highlight
    if (event.previous) {
      setLabelFeatureState(event.previous, { highlight: false });
    }
    // Set new highlight
    if (event.entity) {
      setLabelFeatureState(event.entity, { highlight: true });
    }
  }

  if (event.type === "active") {
    // Clear previous active
    if (event.previous) {
      setLabelFeatureState(event.previous, { active: false });
    }
    // Set new active
    if (event.entity) {
      setLabelFeatureState(event.entity, { active: true });
    }
  }
}
```

### `hasData` Computation

`hasData` is computed during map viewport changes:

1. On `moveend`/`zoomend`, query visible label features
2. For each feature, resolve entity via spatial index
3. Set `hasData=true` for features with matching entities

This is decoupled from highlight/active state.

---

## 5. Files/Concepts to DELETE or REWRITE

### DELETE Entirely

| File | Reason |
|------|--------|
| `lib/map/mapSelection.ts` | Replaced by `lib/selection/types.ts` |
| `lib/map/cityHighlightLayers.ts` | Replaced by map adapter using SelectionService |

### REWRITE Substantially

| File | Changes |
|------|---------|
| `lib/map/mapInteractionService.ts` | Becomes map adapter, produces SelectionService events |
| `lib/map/interactiveLayers.ts` | Simplify to pure label identity extraction |
| `components/vector-map.tsx` | Use SelectionService, remove direct state management |
| `components/right-panel-details-card.tsx` | Use SelectionService + EntityDataProvider |
| `components/right-panel.tsx` | Remove MapSelection prop, use SelectionService |
| `app/page.tsx` | Remove local selection state, use SelectionService |
| `lib/data/communesIndexLite.ts` | Becomes part of StaticFilesEntityDataProvider |
| `lib/data/infraZonesIndexLite.ts` | Becomes part of StaticFilesEntityDataProvider |

### KEEP (Layer Registry)

| File | Status |
|------|--------|
| `lib/map/registry/layerRegistry.ts` | KEEP – constants and helpers |
| `lib/map/layers/*` | KEEP – style layer definitions |
| `lib/map/style/*` | KEEP – style pipeline |
| `lib/data/communeSpatialIndex.ts` | KEEP – used for entity resolution |
| `lib/data/infraZoneSpatialIndex.ts` | KEEP – used for entity resolution |
| `lib/data/nameNormalization.ts` | KEEP – shared utilities |

---

## 6. Map ↔ Panel Decoupling Rules

### Dependency Graph

```
                    SelectionService
                    EntityDataProvider
                           │
         ┌─────────────────┼─────────────────┐
         │                 │                 │
         ▼                 ▼                 ▼
      Map Adapter     Right Panel      Other Consumers
         │                 │
         │                 │
         ▼                 ▼
    MapLibre GL         React UI
```

### Forbidden Imports

```typescript
// ❌ FORBIDDEN in right-panel*.tsx
import { ... } from "@/lib/map/*";
import { Map } from "maplibre-gl";

// ❌ FORBIDDEN in map adapter
import { ... } from "@/components/*";

// ❌ FORBIDDEN in SelectionService
import { ... } from "maplibre-gl";
import { ... } from "react";
```

### Allowed Imports

```typescript
// ✅ Map adapter may import
import { SelectionService } from "@/lib/selection";
import { resolveCommuneByClick } from "@/lib/data/communeSpatialIndex";

// ✅ Right panel may import
import { SelectionService } from "@/lib/selection";
import { EntityDataProvider } from "@/lib/data/entityDataProvider";

// ✅ Both may import
import { EntityRef, CommuneData } from "@/lib/selection/types";
```

---

## 7. IndexedDB Cache Implementation

### Database Schema

```typescript
const DB_NAME = "choisir-sa-ville-cache";
const DB_VERSION = 1;

interface CacheEntry<T> {
  key: string;           // entityKind:entityId
  data: T;
  expiresAt: number;     // timestamp
  dataVersion?: string;  // optional dataset version
}

// Object stores:
// - "communes" -> CacheEntry<CommuneData>
// - "infraZones" -> CacheEntry<InfraZoneData>
```

### Cache Key Format

```
commune:{inseeCode}[:v{datasetVersion}]
infraZone:{id}[:v{datasetVersion}]
```

### TTL Policy

- Default TTL: 7 days (604800000 ms)
- Entry is valid if: `Date.now() < entry.expiresAt`
- Dataset version change forces refresh (version in key)

---

## 8. Implementation Order

1. **Create domain types** (`lib/selection/types.ts`)
2. **Create SelectionService** (`lib/selection/selectionService.ts`)
3. **Create EntityDataProvider interface** (`lib/data/entityDataProvider.ts`)
4. **Create IndexedDB cache** (`lib/data/cache/indexedDbCache.ts`)
5. **Create CachedEntityDataProvider** (`lib/data/cache/cachedEntityDataProvider.ts`)
6. **Create StaticFilesEntityDataProvider** (`lib/data/staticFilesEntityDataProvider.ts`)
7. **Create provider singleton** (`lib/data/index.ts`)
8. **Refactor map adapter** (uses SelectionService)
9. **Refactor right panel** (uses SelectionService + EntityDataProvider)
10. **Update page.tsx** (remove local state)
11. **Delete obsolete files**
12. **Run typecheck and test**
