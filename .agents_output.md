# Managed Labels Implementation Summary

## What changed

- Added a `debug.managedCityLabelsEnabled` toggle plus `cityLabelLayerIds` in `map-tiles.json` so the feature can be switched off or pointed at different OpenMapTiles layers without code changes.
- `loadVectorMapStyle()` now clones each configured OMT place label layer into two layers: the original keeps every class except city/town/village, while a new `managed-city-label::<layerId>` copy renders only those classes but with our palette. Collisions stay identical because all placement/layout keys are copied byte-for-byte.
- Each managed layer receives metadata flags so `cityInteractiveLayer` and `cityHighlightLayers` latch onto them automatically; existing highlight layers still provide the hover overlay (`commune-label-hover-highlight::<layerId>`) with `text-allow-overlap` and `text-ignore-placement`.
- `mapInteractionService` now returns the pointer `lngLat`, exposes the feature `class`, stores the click location inside `CityIdentity`, widens click hit-testing, and deduplicates unresolved-INSEE warnings. INSEE resolution keeps using (in order) `insee`, `osm_id`, `wikidata` from the vector features/mapping index.

## Layer details

- Managed layer IDs created: `managed-city-label::place_label_other`, `managed-city-label::place_label_city` (extensible via config).
- Original layers are filtered with `!["in","class","city","town","village"]`; managed copies use `["in","class","city","town","village"]` plus the original filter, keeping every placement value identical while only paint colors/halo differ.
- Hover overlay layers remain `commune-label-hover-highlight::<managedLayerId>`; they show only the currently hovered ID via `setHoveredCity()` filters and keep `text-allow-overlap=true` / `text-ignore-placement=true`, so they never affect symbol collisions. Text styling is slightly heavier (halo + optional size bump) but independent of placement.

## INSEE resolution

- Resolution order per event: (1) direct `insee` property if present; (2) `/data/city-osm-insee.json` lookup by `osm_id`; (3) lookup by `wikidata`. When all fail we log a deduplicated warning containing `osm_id`, `wikidata`, city name, and the pointer `lngLat`.

## Files touched

- `apps/web/lib/config/debugConfig.ts`, `apps/web/lib/config/appConfig.ts`, `apps/web/public/config/map-tiles.json`, `apps/web/lib/config/mapTilesConfig.ts`
- `apps/web/lib/map/mapStyle.ts`, `apps/web/lib/map/interactiveLayers.ts`, `apps/web/lib/map/cityInteractiveLayer.ts`, `apps/web/lib/map/cityHighlightLayers.ts`
- `apps/web/lib/map/mapInteractionService.ts`, `apps/web/lib/map/cityInseeIndex.ts`
- `apps/web/components/vector-map.tsx`

## Limitations / next steps

- Managed-label colors/fonts are currently hard-coded; consider moving palette tokens to theme config if designers want runtime tweaks.
- Hover overlay still relies on filter swaps per layer; migrating to `feature-state` could reduce filter churn if we later support simultaneous selections.
- The INSEE mapping file ships with a small sample; importing the full dataset will further reduce unresolved hits.
