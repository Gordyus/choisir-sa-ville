# MapLibre Style Review – OUTPUT REQUIREMENTS

## A) Structured Code Review

### URL correctness
- ? `styleUrl` points to `http://localhost:8080/styles/basic/style.json` (matches authoritative endpoint).
- ? `map-tiles.json` uses TileJSON URLs with `.json` suffix (`/data/france.json`, `/data/communes.json`, `/data/arr_municipal.json`) which are explicitly forbidden. Must be `/data/france`, `/data/communes`, `/data/arr_municipal`.
- ? No code-level fallback to legacy endpoints (no `/styles/basic-preview`, `/data/v3*` seen).

### TileJSON usage correctness
- `stylePipeline.loadTileJsonAvailability()` loads TileJSON metadata for all configured sources; failures are handled and do not crash (`loadSourceAvailability` -> missing metadata -> treated as available).
- However, wrong TileJSON URLs in config mean availability is likely empty and injected sources may fail to load.

### Injected vector sources (communes / arr_municipal)
- `injectAdminPolygons()` injects two layers per source (fill + line), with min/max zoom ranges and hover/selected feature-state styling.
- `promoteId` is set per configured source-layer to `insee` (from `FEATURE_FIELDS.inseeCode`). This is correct for feature-state.
- If TileJSON metadata is missing or mismatched, layers are skipped with a single warning (deduped).

### Managed label split (city / town / village)
- `splitCityLabelLayers()` duplicates target label layers and splits by place classes using include/exclude filters. Base layer excludes managed classes, managed layer includes only managed classes (no duplicate labels).
- Target layer IDs come from `config.cityLabelLayerIds` (default `place_label_other`, `place_label_city`). This is OK **only if** those layers carry `class=city/town/village` in the style.
- ? Feature-state key mismatch: managed label paint uses `feature-state: hovered`, but the interaction sets `feature-state: hover`. Hover styling won’t apply. Should align keys.
- ? Managed labels are toggleable via `debug.managedCityLabelsEnabled`; spec says no dual systems/legacy toggles. Should remove toggle and always enable managed labels.

### Expression correctness
- Hover/selected expressions in `hoverState.ts` are safe (no nested zoom interpolations). Good.
- `applyHoverResponsiveTextSize` only applies when base size is numeric, which avoids MapLibre “Only one zoom-based step/interpolate” error.
- If you ever want hover scaling for zoom-interpolated sizes, it must be implemented without nesting a zoom expression inside a `case` (i.e., keep only one zoom interpolate per expression path).

### Legacy/backward compatibility leftovers
- `baseLabels.ensureHitboxLayers` + `listHitboxLayerIds` are unused since `cityInteractiveLayer` manages hitboxes from managed label layers. This is a dual system and should be removed.
- Debug-only toggles (`managedCityLabelsEnabled`) are legacy-ish and conflict with the “always managed labels” requirement.

### Consistency of IDs / metadata / config schema
- `FEATURE_FIELDS.inseeCode` is used consistently for polygons.
- Label feature-state relies on `feature.id` or `properties.insee` from OMT tiles. If the tileset has no stable `id`/`insee`, `setFeatureState` may fail. This is handled by try/catch but results in no hover/selection effect.
- Config lacks `excludeLayers` and `optionalSourceLayers` fields required by the spec, and `sanitizeLayers` does not implement those rules.

## B) Concrete Edit Plan (file by file)

### `apps/web/public/config/map-tiles.json`
- Replace TileJSON URLs:
  - `http://localhost:8080/data/france`
  - `http://localhost:8080/data/communes`
  - `http://localhost:8080/data/arr_municipal`
- Ensure both `tileJsonSources` and `polygonSources.*.tileJsonUrl` use these authoritative endpoints.

### `apps/web/lib/config/mapTilesConfig.ts`
- Add `excludeLayers?: string[]` and `optionalSourceLayers?: string[]` to schema.
- Parse and validate these arrays (string IDs or source-layer names).

### `apps/web/lib/map/style/styleSanitizer.ts`
- Implement removal by `excludeLayers` (match by layer id OR source-layer name).
- Implement `optionalSourceLayers` (remove only if source-layer not available in TileJSON).
- Keep current availability-based pruning for other layers.

### `apps/web/lib/map/style/stylePipeline.ts`
- Pass `excludeLayers` and `optionalSourceLayers` into `sanitizeLayers`.
- Remove any dead/legacy branches if present (none found yet).

### `apps/web/lib/map/layers/managedCityLabels.ts`
- Replace `feature-state: hovered` with `feature-state: hover` to match interaction.
- Keep `selected` unchanged.

### `apps/web/lib/config/debugConfig.ts` + `apps/web/components/vector-map.tsx`
- Remove `managedCityLabelsEnabled` from debug config and from `loadMapStyle` options; managed labels should be always on.

### `apps/web/lib/map/layers/baseLabels.ts` + `apps/web/lib/map/layers/index.ts`
- Remove unused hitbox helpers (`ensureHitboxLayers`, `listHitboxLayerIds`, etc.) to avoid dual systems.

### `apps/web/lib/map/cityHighlightLayers.ts`
- (Optional) Add a guard/log if `setFeatureState` fails due to missing feature `id` to make the failure explicit.

## C) Manual Sanity Test Plan (5–10 steps)
1. Open `http://localhost:8080/styles/basic/style.json` in browser (200 OK, valid JSON).
2. Open TileJSON endpoints:
   - `http://localhost:8080/data/france`
   - `http://localhost:8080/data/communes`
   - `http://localhost:8080/data/arr_municipal`
3. Start app, verify map loads without console warnings about invalid TileJSON or missing source-layers.
4. Check console: no `[style-sanitizer]` warnings for layers you expect to keep.
5. Hover labels at multiple zoom levels (city/town/village): hover styling should apply consistently.
6. Click a label: selected styling should override hover styling.
7. Hover commune polygon at z9–z13: fill/line responds to hover; selection works on click.
8. Hover arrondissement polygon at z11–z13: fill/line responds to hover; selection works on click.
9. Ensure no MapLibre errors about zoom-based interpolate/step nesting.
10. Confirm no duplicate city labels (base + managed) visible simultaneously.

---

## Legacy removal checklist
- [ ] Remove debug toggle `managedCityLabelsEnabled`
- [ ] Remove unused hitbox helpers in `baseLabels.ts`
- [ ] Remove any references to old TileJSON endpoints (`/data/*.json`)
- [ ] Remove any unused exports in `layers/index.ts` tied to removed helpers

## Final authoritative endpoints used
- Base style: `http://localhost:8080/styles/basic/style.json`
- TileJSON (vector sources):
  - `http://localhost:8080/data/france`
  - `http://localhost:8080/data/communes`
  - `http://localhost:8080/data/arr_municipal`

## Final injected sources (source-layer + promoteId)
- `communes`
  - `tileJsonUrl`: `http://localhost:8080/data/communes`
  - `source-layer`: `communes`
  - `promoteId`: `{ communes: "insee" }`
- `arr_municipal`
  - `tileJsonUrl`: `http://localhost:8080/data/arr_municipal`
  - `source-layer`: `arr_municipal`
  - `promoteId`: `{ arr_municipal: "insee" }`

## Interactive layers queried for hover/click
- Label hitboxes: `city-hitbox::<managedLabelLayerId>` (one per managed city label layer)
- Polygons: `communes-fill`, `arr-municipal-fill`

## Expressions changed and justification
- Change managed label hover key from `feature-state: hovered` to `feature-state: hover` so expressions match the state set by interactions.
- Keep existing hover/selected expressions for polygons and labels (no nested zoom interpolations; avoids MapLibre error).

## Manual test plan (summary)
1) Validate style + TileJSON URLs in browser.
2) Load app, confirm no TileJSON/source-layer warnings.
3) Hover/click labels at multiple zoom levels.
4) Hover/click commune polygons at z9–z13.
5) Hover/click arrondissement polygons at z11–z13.
6) Confirm no duplicate labels or MapLibre expression errors.
