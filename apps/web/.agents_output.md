# Selection & Data Provider Architecture - Refactor Summary

## Architecture Overview

This document describes the greenfield selection and data provider architecture after the complete decoupling of map and panel components.

### Central Design Principles

1. **Map and Panel are completely decoupled** - Neither imports the other
2. **SelectionService is the single source of truth** for selection state
3. **EntityDataProvider abstracts all data access** with mandatory caching
4. **Feature-state for visual feedback** - Map labels styled via hover/selected states

---

## Module Structure

```
apps/web/lib/
├── selection/              # UI-agnostic selection state
│   ├── types.ts           # EntityRef, SelectionState, CommuneData, InfraZoneData
│   ├── selectionService.ts # Headless state management singleton
│   ├── hooks.ts           # React hooks (useSelection, useActiveEntity, etc.)
│   └── index.ts           # Public exports
│
├── data/                   # Entity data access layer
│   ├── entityDataProvider.ts    # Interface + BaseEntityDataProvider
│   ├── staticFilesEntityDataProvider.ts # Fetches from /data/{version}/...
│   ├── hooks.ts                 # React hooks (useEntity, useCommune, etc.)
│   ├── index.ts                 # Singleton + convenience functions
│   └── cache/
│       ├── indexedDbCache.ts         # 7-day TTL IndexedDB cache
│       ├── cachedEntityDataProvider.ts # Decorator with caching
│       └── index.ts
│
└── map/
    └── mapInteractionService.ts  # Map interactions → SelectionService
```

---

## Core Types

### EntityRef (lib/selection/types.ts)

```typescript
type EntityRef =
    | { kind: "commune"; inseeCode: string }
    | { kind: "infraZone"; id: string };
```

### SelectionState

```typescript
interface SelectionState {
    highlighted: EntityRef | null;  // Hover state
    active: EntityRef | null;       // Click/selected state
}
```

### CommuneData / InfraZoneData

```typescript
interface CommuneData {
    inseeCode: string;
    name: string;
    departmentCode?: string;
    regionCode?: string;
    population?: number;
}

interface InfraZoneData {
    id: string;
    name: string;
    type?: string;
    code?: string;
    parentCommuneCode?: string;
    population?: number;
}
```

---

## SelectionService API

```typescript
interface SelectionService {
    getState(): SelectionState;
    setHighlighted(entity: EntityRef | null): void;
    setActive(entity: EntityRef | null): void;
    clearAll(): void;
    subscribe(listener: () => void): () => void;
    isActive(entity: EntityRef): boolean;
    isHighlighted(entity: EntityRef): boolean;
}

// Usage
const service = getSelectionService(); // Singleton
service.setActive({ kind: "commune", inseeCode: "75056" });
const unsubscribe = service.subscribe(() => console.log(service.getState()));
```

---

## EntityDataProvider API

```typescript
interface EntityDataProvider {
    getCommune(inseeCode: string, signal?: AbortSignal): Promise<CommuneData | null>;
    getInfraZone(id: string, signal?: AbortSignal): Promise<InfraZoneData | null>;
    getEntity(ref: EntityRef, signal?: AbortSignal): Promise<EntityData | null>;
    hasEntity(ref: EntityRef, signal?: AbortSignal): Promise<boolean>;
    getParentCommune(infraZoneId: string, signal?: AbortSignal): Promise<CommuneData | null>;
}

// Usage
const provider = getEntityDataProvider(); // Singleton (cached + static files)
const commune = await provider.getCommune("75056");
```

---

## React Hooks

### Selection Hooks (lib/selection/hooks.ts)

```typescript
// Subscribe to full state
const state = useSelectionState();

// Get specific entities
const highlighted = useHighlightedEntity();
const active = useActiveEntity();

// Check specific entity
const isHighlighted = useIsHighlighted(ref);
const isActive = useIsActive(ref);

// Actions
const { setHighlighted, setActive, clearAll, activateHighlighted } = useSelectionActions();

// Combined
const { highlighted, active, setHighlighted, setActive, clearAll } = useSelection();
```

### Data Hooks (lib/data/hooks.ts)

```typescript
// Fetch entity data
const { data, loading, error, refetch } = useEntity(ref);
const { data, loading, error, refetch } = useCommune(inseeCode);
const { data, loading, error, refetch } = useInfraZone(id);

// Check data availability
const hasData = useHasEntity(ref);
```

---

## Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                          User Interaction                        │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                     mapInteractionService                        │
│  - Handles mousemove/click on map labels                        │
│  - Resolves LabelIdentity → EntityRef (via spatial indexes)     │
│  - Calls selectionService.setHighlighted/setActive              │
│  - Manages feature-state for visual feedback                    │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                      SelectionService                            │
│  - Single source of truth for selection state                   │
│  - Notifies all subscribers on state change                     │
└─────────────────────────────────────────────────────────────────┘
                          │                    │
                          ▼                    ▼
┌───────────────────────────────┐  ┌───────────────────────────────┐
│        VectorMap              │  │       RightPanel              │
│  - Renders map                │  │  - useActiveEntity() hook     │
│  - Attaches interaction svc   │  │  - Fetches data via provider  │
│  - NO selection state         │  │  - NO map dependency          │
└───────────────────────────────┘  └───────────────────────────────┘
```

---

## Cache Architecture

### IndexedDB Cache

- **Database**: `choisir-sa-ville-cache`
- **Store**: `entities`
- **TTL**: 7 days (configurable)
- **Versioning**: Cache keys include data version for invalidation

### CachedEntityDataProvider (Decorator Pattern)

```typescript
const staticProvider = new StaticFilesEntityDataProvider({ version: "v1" });
const cachedProvider = new CachedEntityDataProvider(staticProvider, {
    dataVersion: "v1",
    ttlMs: 7 * 24 * 60 * 60 * 1000 // 7 days
});
```

---

## Files Deleted

- `lib/map/mapSelection.ts` - Replaced by EntityRef in selection/types.ts
- `lib/map/cityHighlightLayers.ts` - Feature-state now inline in mapInteractionService.ts
- Old versions: `*.old.tsx`, `*.old.ts`

---

## Files Created

| File | Purpose |
|------|---------|
| `lib/selection/types.ts` | EntityRef, SelectionState, CommuneData, InfraZoneData |
| `lib/selection/selectionService.ts` | Headless state management singleton |
| `lib/selection/hooks.ts` | React hooks for selection |
| `lib/selection/index.ts` | Public exports |
| `lib/data/entityDataProvider.ts` | Interface + BaseEntityDataProvider |
| `lib/data/staticFilesEntityDataProvider.ts` | Fetches from /data/{version}/... |
| `lib/data/hooks.ts` | React hooks for data fetching |
| `lib/data/index.ts` | Singleton + convenience functions |
| `lib/data/cache/indexedDbCache.ts` | IndexedDB cache with TTL |
| `lib/data/cache/cachedEntityDataProvider.ts` | Decorator with caching |
| `lib/data/cache/index.ts` | Cache exports |

---

## Files Modified

| File | Changes |
|------|---------|
| `lib/map/mapInteractionService.ts` | Rewritten to use SelectionService, inline feature-state |
| `components/vector-map.tsx` | Removed onSelect prop, simplified cleanup |
| `components/right-panel.tsx` | Removed selection prop |
| `components/right-panel-details-card.tsx` | Uses useActiveEntity() hook |
| `app/page.tsx` | Removed local selection state |

---

## Dependency Rules

| Module | Can Import | Cannot Import |
|--------|-----------|---------------|
| `lib/selection/*` | Nothing from lib/map or components | - |
| `lib/data/*` | `lib/selection/types` only | lib/map, components |
| `lib/map/*` | `lib/selection`, `lib/data` | components |
| `components/vector-map.tsx` | `lib/map/*` | right-panel components |
| `components/right-panel*.tsx` | `lib/selection`, `lib/data` | lib/map, vector-map |
| `app/page.tsx` | All components | lib/map internals |

---

## Verification Checklist

- [x] No `excludeLayers` or `optionalSourceLayers` in codebase
- [x] No `vectorTilesBaseUrl` in codebase
- [x] No `setStyle` calls after initial load
- [x] No backward-compat re-exports
- [x] No fallback layer discovery
- [x] No legacy config normalization
- [x] No DEFAULT_CONFIG objects
- [x] TypeScript compiles without errors
- [x] Single code path for style loading
- [x] Admin polygons injected programmatically
- [x] Layer ordering is deterministic

---

## Technical Notes

### MapLibre Best Practices Applied

- **promoteId** configured for stable feature identity on polygon sources
- **feature-state** used for hover/selected styling (no filter manipulation)
- **addSource/addLayer** with explicit ordering (no setStyle after init)
- **Single zoom interpolate** per property (no nested zoom expressions)

### Data Resolution Fallbacks (Intentionally Kept)

The following are **data fallbacks** (not architecture fallbacks) and remain in the codebase:

- `FEATURE_FIELDS.fallbackIds` - For features without INSEE codes
- `CityResolutionMethod = "fallback"` - When city can't be resolved via polygon/OSM/Wikidata
- `LegacyFilterSpecification` - MapLibre GL type name (not legacy code)
