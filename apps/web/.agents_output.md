# MapLibre Layers/Sources Refactor Summary

## Overview
One-shot refactor to redesign how MapLibre layers and sources are managed. The monolithic 835-line `mapStyle.ts` has been replaced with a modular architecture using three focused directories.

## New Architecture

```
lib/map/
├── registry/           # Single source of truth for IDs and constants
│   ├── layerRegistry.ts
│   └── index.ts
├── style/              # Style loading and transformation pipeline
│   ├── styleLoader.ts
│   ├── styleSanitizer.ts
│   ├── stylePipeline.ts (main entry)
│   └── index.ts
├── layers/             # Layer injection and styling logic
│   ├── hoverState.ts
│   ├── adminPolygons.ts
│   ├── baseLabels.ts
│   ├── managedCityLabels.ts
│   └── index.ts
├── cityHighlightLayers.ts  (updated)
├── cityInseeIndex.ts       (unchanged)
├── cityInteractiveLayer.ts (updated)
├── interactiveLayers.ts    (updated)
└── mapInteractionService.ts (updated)
```

## Key Files Created

### Registry Module
- **layerRegistry.ts**: SOURCE_IDS, LAYER_IDS, SOURCE_LAYERS, ZOOM_RANGES, FEATURE_FIELDS, ADMIN_POLYGON_SPECS, OMT_LABEL_LAYER_IDS, helper functions

### Style Module
- **styleLoader.ts**: Pure data fetching (fetchJson, loadStyle, loadTileJsonMetadata, loadSourceAvailability)
- **styleSanitizer.ts**: Layer cleanup (excludeLayers, optionalSourceLayers, missing source-layer removal)
- **stylePipeline.ts**: Main orchestrator - `loadMapStyle(config, signal, options)`

### Layers Module
- **hoverState.ts**: Feature-state expression builders (FIXES zoom interpolate error)
- **adminPolygons.ts**: Injects communes and arr_municipal polygon sources/layers
- **baseLabels.ts**: Place class filtering and hitbox layer creation
- **managedCityLabels.ts**: Splits OMT label layers for hover/selection styling

## Issues Fixed

### 1. Expression Error: "Only one zoom-based step/interpolate subexpression"
**Root cause**: The old code nested zoom-based interpolate expressions inside case expressions.

**Fix**: `hoverState.ts` uses simple case expressions with fixed values per state instead of nesting zoom-based interpolations:
```typescript
export function buildLineWidthExpr(): ExpressionSpecification {
    return [
        "case",
        ["boolean", ["feature-state", "selected"], false],
        COMMUNE_LINE_WIDTH.selected,  // Fixed value, not zoom interpolate
        ["boolean", ["feature-state", "hovered"], false],
        COMMUNE_LINE_WIDTH.hover,
        COMMUNE_LINE_WIDTH.base
    ];
}
```

### 2. Source-layer Missing Warnings
**Root cause**: Layers referenced source-layers that didn't exist in the tile metadata.

**Fix**: 
- `styleSanitizer.ts` checks TileJSON metadata before including layers
- `adminPolygons.ts` uses configurable `sourceLayer` from `polygonSources` config
- `isSourceLayerAvailable()` validates before injection

### 3. Style URL 404 Issues
**Fix**: `stylePipeline.ts` uses `config.styleUrl` directly from MapTilesConfig without any transformations.

### 4. Monolithic Code
**Fix**: Split 835-line `mapStyle.ts` into 8+ focused modules with clear responsibilities.

## Breaking Changes

1. **Import path changed**: 
   - Old: `import { loadVectorMapStyle } from "@/lib/map/mapStyle"`
   - New: `import { loadMapStyle } from "@/lib/map/style/stylePipeline"`

2. **Function renamed**:
   - Old: `loadVectorMapStyle()`
   - New: `loadMapStyle()`

3. **File deleted**: `mapStyle.ts` removed entirely

## Backward Compatibility

The following re-exports maintain backward compatibility:
- `interactiveLayers.ts` re-exports `ADMIN_POLYGON_LAYER_SPECS`, `CityIdentity`, etc.
- `COMMUNE_INTERACTIVE_LAYER_PREFIX` re-exported from `cityInteractiveLayer.ts`
- All public types preserved

## Configuration

Source layers are now configurable via `polygonSources` in `MapTilesConfig`:
```typescript
polygonSources: {
    communes: {
        tileJsonUrl: "http://localhost:8080/data/communes.json",
        sourceLayer: "communes"  // Configurable!
    },
    arr_municipal: {
        tileJsonUrl: "http://localhost:8080/data/arr_municipal.json",
        sourceLayer: "arr_municipal"
    }
}
```

## TypeScript

All files pass `tsc --noEmit` with `exactOptionalPropertyTypes: true`.

## Next Steps

1. Test the map in browser to verify functionality
2. Verify hover/selection states work correctly
3. Check console for any remaining warnings
4. Consider adding unit tests for the new modules
