# MapLibre Layer Management System - Refactor Summary

## Architecture Overview

This document describes the greenfield MapLibre layer management architecture after the complete removal of all legacy/backward-compatibility code.

### Single Source of Truth

All layer management flows through **one deterministic pipeline**:

1. **`loadMapStyle(config)`** - Entry point in `stylePipeline.ts`
2. **`layerRegistry.ts`** - All layer IDs, source names, and specs defined here
3. **`adminPolygons.ts`** - Programmatic injection of commune/arrondissement layers
4. **`managedCityLabels.ts`** - City label splitting for feature-state styling

### Layer Ordering

Layers are inserted in a **deterministic order** (bottom to top):

1. Base OpenMapTiles layers (from style.json)
2. **Polygon fill layers** (communes-fill, arr-municipal-fill)
3. **Polygon line layers** (communes-line, arr-municipal-line)
4. **Symbol layers** (labels) - split into:
   - Base label layers (excluding city classes)
   - Managed city label layers (with feature-state styling)
5. **City hitbox layers** (invisible interaction targets)

### Responsibilities

| Module | Responsibility |
|--------|----------------|
| `stylePipeline.ts` | Orchestrates style loading and transformation |
| `styleLoader.ts` | Pure data fetching (style JSON, TileJSON) |
| `styleSanitizer.ts` | Removes layers with unavailable source-layers |
| `layerRegistry.ts` | Layer IDs, source IDs, zoom ranges, feature fields |
| `adminPolygons.ts` | Creates and injects polygon sources/layers |
| `managedCityLabels.ts` | Splits labels for hover/selection styling |
| `baseLabels.ts` | Place class filtering (city/town/village) |
| `hoverState.ts` | Feature-state expressions for styling |
| `cityInteractiveLayer.ts` | Creates invisible hitbox layers |
| `mapInteractionService.ts` | Handles mouse interactions and feature state |

---

## What Was Removed

### Config Options (mapTilesConfig.ts)

- `excludeLayers` - Manual layer exclusion list
- `optionalSourceLayers` - Conditional layer removal
- `vectorTilesBaseUrl` - Legacy base URL
- `parseOptionalStringArray()` - Helper function for removed options
- All fallback/default config normalization

### Style Processing (styleSanitizer.ts, stylePipeline.ts)

- `excludeLayers` handling
- `optionalSourceLayers` handling
- Complex conditional sanitization logic

### Interactive Layers (interactiveLayers.ts)

- Backward-compat re-exports (ADMIN_POLYGON_LAYER_SPECS, etc.)
- Legacy constants (COMMUNE_POLYGON_SOURCE_ID, COMMUNE_LABEL_LAYERS, etc.)
- `_updatePlaceClassSet` internal function
- `CITY_ID_EXPRESSION`, `createCityIdMatchExpression`
- `pickCityIdFieldFromFeatures`

### City Interactive Layer (cityInteractiveLayer.ts)

- Backward-compat re-exports (buildInteractiveLayerId, extractLabelLayerIdFromInteractive)
- `COMMUNE_INTERACTIVE_LAYER_PREFIX` legacy constant
- `MANAGED_CITY_LABEL_METADATA_FLAG` duplication
- Fallback OMT label layer lookup

### Interaction Service (mapInteractionService.ts)

- `warnMissingInteractiveLayer` function
- Implicit interactive layer discovery
- Fallback resolution paths

### City Highlight (cityHighlightLayers.ts)

- Legacy MANAGED_CITY_LABEL_METADATA_FLAG constant
- COMMUNE_LABEL_LAYERS fallback list
- Local isManagedCityLabelLayer (now imports from managedCityLabels.ts)

---

## Files Modified

- `apps/web/lib/config/mapTilesConfig.ts` - Strict config with no optional legacy fields
- `apps/web/lib/map/style/stylePipeline.ts` - Simplified to single code path
- `apps/web/lib/map/style/styleSanitizer.ts` - Only checks source-layer availability
- `apps/web/lib/map/interactiveLayers.ts` - Clean city identity extraction
- `apps/web/lib/map/cityInteractiveLayer.ts` - Uses only managed label layers
- `apps/web/lib/map/mapInteractionService.ts` - Requires explicit interactiveLayerIds
- `apps/web/lib/map/cityHighlightLayers.ts` - Imports from managedCityLabels
- `apps/web/public/config/map-tiles.json` - Only required config keys

---

## Verification Checklist

- [x] No `excludeLayers` or `optionalSourceLayers` in codebase
- [x] No `vectorTilesBaseUrl` in codebase
- [x] No `setStyle` calls after initial load
- [x] No backward-compat re-exports
- [x] No fallback layer discovery
- [x] No legacy config normalization
- [x] No DEFAULT_CONFIG objects
- [x] TypeScript compiles without errors
- [x] Single code path for style loading
- [x] Admin polygons injected programmatically
- [x] Layer ordering is deterministic

---

## Technical Notes

### MapLibre Best Practices Applied

- **promoteId** configured for stable feature identity on polygon sources
- **feature-state** used for hover/selected styling (no filter manipulation)
- **addSource/addLayer** with explicit ordering (no setStyle after init)
- **Single zoom interpolate** per property (no nested zoom expressions)

### Data Resolution Fallbacks (Intentionally Kept)

The following are **data fallbacks** (not architecture fallbacks) and remain in the codebase:

- `FEATURE_FIELDS.fallbackIds` - For features without INSEE codes
- `CityResolutionMethod = "fallback"` - When city can't be resolved via polygon/OSM/Wikidata
- `LegacyFilterSpecification` - MapLibre GL type name (not legacy code)
