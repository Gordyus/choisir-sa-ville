<div class="app-shell">
  <main class="map-wrap">
    <app-map
      [markers]="(markers$ | async) ?? []"
      [routeLine]="(routeLine$ | async) ?? []"
    ></app-map>
  </main>
  <aside class="panel">
    <div class="panel-header">
      <div>
        <p class="eyebrow">Cities Explorer</p>
        <h1>Choisir sa ville</h1>
        <p class="subtitle">Live map of communes and infra context.</p>
      </div>
      <form class="search" (ngSubmit)="runSearch()">
        <label>
          <span>Search area</span>
          <input
            type="text"
            name="areaQuery"
            [(ngModel)]="areaInput"
            placeholder="City, postal code, region, department"
            (input)="onAreaInput()"
            (keydown)="onAreaKey($event)"
          />
        </label>
        <ul class="geocode-suggestions" *ngIf="areaSuggestions.length > 0">
          <li
            *ngFor="let candidate of areaSuggestions; let i = index"
            [class.active]="i === areaSuggestionIndex"
            (click)="selectAreaCandidate(candidate)"
          >
            {{ candidate.label }}
          </li>
        </ul>
        <span class="hint" *ngIf="isAreaSuggesting">Searching locations...</span>
        <span class="hint" *ngIf="resolvedAreaLabel">
          Selected area: {{ resolvedAreaLabel }}
        </span>
        <label>
          <span>Keyword</span>
          <input
            type="text"
            name="query"
            [(ngModel)]="query"
            placeholder="City name or postal code"
          />
        </label>
        <button type="submit">Search this area</button>
      </form>
    </div>
    <section class="panel-section" *ngIf="viewState$ | async as viewState">
      <ng-container [ngSwitch]="viewState.status">
        <div class="detail-card" *ngSwitchCase="'idle'">
          <h2 class="detail-title">Search the map</h2>
          <div class="detail-meta">
            <span>Move the map to set a search area.</span>
            <span>Click "Search this area" to load results.</span>
          </div>
        </div>
        <div class="detail-card" *ngSwitchCase="'loading'">
          <h2 class="detail-title">Searching...</h2>
          <div class="detail-meta">
            <span>Fetching zones for the current map view.</span>
          </div>
        </div>
        <div class="detail-card" *ngSwitchCase="'error'">
          <h2 class="detail-title">Search failed</h2>
          <div class="detail-meta">
            <span>{{ viewState.message ?? "Unable to load results." }}</span>
          </div>
        </div>
        <ng-container *ngSwitchCase="'loaded'">
          <div class="detail-card">
            <div class="detail-meta">
              <span>{{ viewState.total }} zones found</span>
              <span>Showing {{ viewState.rows.length }} results</span>
            </div>
          </div>
          <div class="detail-card">
            <h3 class="detail-title">Travel options</h3>
            <div class="detail-meta">
              <label class="toggle">
                <input type="checkbox" [(ngModel)]="travelEnabled" (change)="applyTravelOptions()" />
                <span>Enable travel time</span>
              </label>
              <label>
                <span>Destination address</span>
                <input
                  type="text"
                  name="destination"
                  [(ngModel)]="destinationInput"
                  placeholder="10 Rue de la Paix, Paris"
                  [disabled]="!travelEnabled"
                  (input)="onDestinationInput()"
                  (keydown)="onDestinationKey($event)"
                />
              </label>
              <ul
                class="geocode-suggestions"
                *ngIf="travelEnabled && destinationSuggestions.length > 0"
              >
                <li
                  *ngFor="let candidate of destinationSuggestions; let i = index"
                  [class.active]="i === suggestionIndex"
                  (click)="selectCandidate(candidate)"
                >
                  {{ candidate.label }}
                </li>
              </ul>
              <label>
                <span>Mode</span>
                <select
                  name="mode"
                  [(ngModel)]="travelMode"
                  (change)="applyTravelOptions()"
                  [disabled]="!travelEnabled"
                >
                  <option value="car">Car</option>
                  <option value="transit">Transit</option>
                </select>
              </label>
              <label>
                <span>Arrive day</span>
                <select
                  name="travelDay"
                  [(ngModel)]="travelDay"
                  [disabled]="!travelEnabled"
                  (change)="clearTravelError()"
                >
                  <option *ngFor="let day of dayOptions" [value]="day.value">
                    {{ day.label }}
                  </option>
                </select>
              </label>
              <label>
                <span>Arrive time</span>
                <select
                  name="travelTime"
                  [(ngModel)]="travelTime"
                  [disabled]="!travelEnabled"
                  (change)="clearTravelError()"
                >
                  <option *ngFor="let time of timeOptions" [value]="time">
                    {{ time }}
                  </option>
                </select>
              </label>
              <button type="button" (click)="applyTravelOptions()" [disabled]="!travelEnabled">
                Apply travel
              </button>
              <span class="hint">Type an address near your search area (lat,lng also works).</span>
              <span class="hint" *ngIf="isSuggesting">Searching addresses...</span>
              <span class="hint" *ngIf="isGeocoding">Looking up address...</span>
              <span class="hint" *ngIf="resolvedDestinationLabel">
                Resolved: {{ resolvedDestinationLabel }}
              </span>
              <span class="error" *ngIf="travelError">{{ travelError }}</span>
              <span class="hint" *ngIf="viewState.travelEnabled && viewState.travelStatus === 'loading'">
                Loading travel times...
              </span>
              <span
                class="error"
                *ngIf="!travelError && viewState.travelEnabled && viewState.travelStatus === 'error'"
              >
                {{ viewState.travelMessage ?? "Travel service unavailable." }}
              </span>
            </div>
          </div>
          <div class="detail-card" *ngIf="viewState.rows.length > 0; else noResults">
            <table class="results-table">
              <thead>
                <tr>
                  <th>Zone</th>
                  <th>Travel</th>
                  <th>Population</th>
                  <th>Dept</th>
                  <th>Region</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let item of viewState.rows"
                  class="results-row"
                  (click)="selectZone(item.zoneId)"
                >
                  <td>{{ item.zoneName }}</td>
                  <td [title]="travelTitle(item.travel)">
                    {{ formatTravel(item.travel, viewState.travelStatus) }}
                  </td>
                  <td>{{ item.attributes.population ?? "-" }}</td>
                  <td>{{ item.attributes.departmentCode ?? "-" }}</td>
                  <td>{{ item.attributes.regionCode ?? "-" }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noResults>
            <div class="detail-card">
              <div class="detail-meta">
                <span>No zones found for this area.</span>
              </div>
            </div>
          </ng-template>
        </ng-container>
      </ng-container>
    </section>
    <section class="panel-body" *ngIf="detailsState$ | async as state">
      <ng-container [ngSwitch]="state.status">
        <div class="detail-card" *ngSwitchCase="'idle'">
          <h2 class="detail-title">Pick a city</h2>
          <div class="detail-meta">
            <span>Click a marker to view details.</span>
            <span>Markers load as you move across the map.</span>
          </div>
        </div>
        <div class="detail-card" *ngSwitchCase="'loading'">
          <h2 class="detail-title">Loading...</h2>
          <div class="detail-meta">
            <span>Fetching city details from the API.</span>
          </div>
        </div>
        <div class="detail-card" *ngSwitchCase="'error'">
          <h2 class="detail-title">Unable to load details</h2>
          <div class="detail-meta">
            <span>{{ state.message ?? "The city details could not be loaded." }}</span>
          </div>
        </div>
        <ng-container *ngSwitchCase="'loaded'">
          <ng-container *ngIf="state.city as city">
            <div class="detail-card">
              <h2 class="detail-title">{{ city.name }}</h2>
              <div class="detail-meta">
                <span>INSEE: {{ city.inseeCode }} - {{ city.slug }}</span>
                <span>
                  Dept: {{ city.departmentName ?? "Unknown" }}
                  ({{ city.departmentCode ?? "?" }})
                </span>
                <span>
                  Region: {{ city.regionName ?? "Unknown" }}
                  ({{ city.regionCode ?? "?" }})
                </span>
                <span>Coords: {{ city.lat ?? "?" }}, {{ city.lon ?? "?" }}</span>
              </div>
            </div>
            <div class="detail-card">
              <h3 class="detail-title">Postal codes</h3>
              <div class="detail-tags" *ngIf="city.postalCodes.length > 0; else noPostal">
                <span class="tag" *ngFor="let code of city.postalCodes">
                  {{ code }}
                </span>
              </div>
              <ng-template #noPostal>
                <div class="detail-tags">
                  <span class="tag">No postal codes</span>
                </div>
              </ng-template>
            </div>
            <div class="detail-card" *ngIf="routeState$ | async as routeState">
              <h3 class="detail-title">Route</h3>
              <ng-container [ngSwitch]="routeState.status">
                <div class="detail-meta" *ngSwitchCase="'idle'">
                  <span>Select a city and enable travel to view the route.</span>
                </div>
                <div class="detail-meta" *ngSwitchCase="'loading'">
                  <span>Loading route...</span>
                </div>
                <div class="detail-meta" *ngSwitchCase="'error'">
                  <span>{{ routeState.message ?? "Route lookup failed." }}</span>
                </div>
                <div class="detail-meta" *ngSwitchCase="'loaded'">
                  <span>Status: {{ routeState.route?.status ?? "ERROR" }}</span>
                  <span>Duration: {{ formatDuration(routeState.route?.duration_s) }}</span>
                  <span>Distance: {{ formatDistance(routeState.route?.distance_m) }}</span>
                  <span *ngIf="routeState.route?.origin?.label">
                    Origin: {{ routeState.route?.origin?.label }}
                  </span>
                  <span *ngIf="routeState.route?.destination?.label">
                    Destination: {{ routeState.route?.destination?.label }}
                  </span>
                </div>
              </ng-container>
            </div>
          </ng-container>
        </ng-container>
      </ng-container>
    </section>
  </aside>
</div>
