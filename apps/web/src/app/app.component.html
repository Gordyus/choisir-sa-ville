<div class="app-shell">
  <main class="map-wrap">
    <app-map [markers]="(markers$ | async) ?? []"></app-map>
  </main>
  <aside class="panel">
    <div class="panel-header">
      <div>
        <p class="eyebrow">Cities Explorer</p>
        <h1>Choisir sa ville</h1>
        <p class="subtitle">Live map of communes and infra context.</p>
      </div>
      <form class="search" (ngSubmit)="runSearch()">
        <label>
          <span>Keyword</span>
          <input
            type="text"
            name="query"
            [(ngModel)]="query"
            placeholder="City name or postal code"
          />
        </label>
        <button type="submit">Search this area</button>
      </form>
    </div>
    <section class="panel-section" *ngIf="searchState$ | async as searchState">
      <ng-container [ngSwitch]="searchState.status">
        <div class="detail-card" *ngSwitchCase="'idle'">
          <h2 class="detail-title">Search the map</h2>
          <div class="detail-meta">
            <span>Move the map to set a search area.</span>
            <span>Click "Search this area" to load results.</span>
          </div>
        </div>
        <div class="detail-card" *ngSwitchCase="'loading'">
          <h2 class="detail-title">Searching...</h2>
          <div class="detail-meta">
            <span>Fetching zones for the current map view.</span>
          </div>
        </div>
        <div class="detail-card" *ngSwitchCase="'error'">
          <h2 class="detail-title">Search failed</h2>
          <div class="detail-meta">
            <span>{{ searchState.message ?? "Unable to load results." }}</span>
          </div>
        </div>
        <ng-container *ngSwitchCase="'loaded'">
          <div class="detail-card">
            <div class="detail-meta">
              <span>{{ searchState.total }} zones found</span>
              <span>Showing {{ searchState.items.length }} results</span>
            </div>
          </div>
          <div class="detail-card" *ngIf="searchState.items.length > 0; else noResults">
            <table class="results-table">
              <thead>
                <tr>
                  <th>Zone</th>
                  <th>Population</th>
                  <th>Dept</th>
                  <th>Region</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let item of searchState.items"
                  class="results-row"
                  (click)="selectZone(item.zoneId)"
                >
                  <td>{{ item.zoneName }}</td>
                  <td>{{ item.attributes.population ?? "-" }}</td>
                  <td>{{ item.attributes.departmentCode ?? "-" }}</td>
                  <td>{{ item.attributes.regionCode ?? "-" }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noResults>
            <div class="detail-card">
              <div class="detail-meta">
                <span>No zones found for this area.</span>
              </div>
            </div>
          </ng-template>
        </ng-container>
      </ng-container>
    </section>
    <section class="panel-body" *ngIf="detailsState$ | async as state">
      <ng-container [ngSwitch]="state.status">
        <div class="detail-card" *ngSwitchCase="'idle'">
          <h2 class="detail-title">Pick a city</h2>
          <div class="detail-meta">
            <span>Click a marker to view details.</span>
            <span>Markers load as you move across the map.</span>
          </div>
        </div>
        <div class="detail-card" *ngSwitchCase="'loading'">
          <h2 class="detail-title">Loading...</h2>
          <div class="detail-meta">
            <span>Fetching city details from the API.</span>
          </div>
        </div>
        <div class="detail-card" *ngSwitchCase="'error'">
          <h2 class="detail-title">Unable to load details</h2>
          <div class="detail-meta">
            <span>{{ state.message ?? "The city details could not be loaded." }}</span>
          </div>
        </div>
        <ng-container *ngSwitchCase="'loaded'">
          <ng-container *ngIf="state.city as city">
            <div class="detail-card">
              <h2 class="detail-title">{{ city.name }}</h2>
              <div class="detail-meta">
                <span>INSEE: {{ city.inseeCode }} - {{ city.slug }}</span>
                <span>
                  Dept: {{ city.departmentName ?? "Unknown" }}
                  ({{ city.departmentCode ?? "?" }})
                </span>
                <span>
                  Region: {{ city.regionName ?? "Unknown" }}
                  ({{ city.regionCode ?? "?" }})
                </span>
                <span>Coords: {{ city.lat ?? "?" }}, {{ city.lon ?? "?" }}</span>
              </div>
            </div>
            <div class="detail-card">
              <h3 class="detail-title">Postal codes</h3>
              <div class="detail-tags" *ngIf="city.postalCodes.length > 0; else noPostal">
                <span class="tag" *ngFor="let code of city.postalCodes">
                  {{ code }}
                </span>
              </div>
              <ng-template #noPostal>
                <div class="detail-tags">
                  <span class="tag">No postal codes</span>
                </div>
              </ng-template>
            </div>
          </ng-container>
        </ng-container>
      </ng-container>
    </section>
  </aside>
</div>
