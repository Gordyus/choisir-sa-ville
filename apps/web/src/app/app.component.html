<div class="app-shell">
  <main class="map-wrap">
    <app-map
      [markers]="(markers$ | async) ?? []"
      [routeLine]="(routeLine$ | async) ?? []"
    ></app-map>
  </main>
  <aside class="panel">
    <div class="panel-header">
      <div>
        <p class="eyebrow">Cities Explorer</p>
        <h1>Choisir sa ville</h1>
        <p class="subtitle">Live map of communes and infra context.</p>
      </div>
      <app-search-area-panel
        [query]="query"
        [suggestions]="(querySuggestions$ | async) ?? []"
        [suggestionIndex]="querySuggestionIndex"
        [isSuggesting]="(isQuerySuggesting$ | async) === true"
        [resolvedAreaLabel]="resolvedAreaLabel"
        (queryUpdated)="updateQuery($event)"
        (queryKey)="onQueryKey($event)"
        (candidateSelected)="selectQueryCandidate($event)"
        (submitSearch)="runSearch()"
      ></app-search-area-panel>
    </div>
    <section class="panel-section" *ngIf="viewState$ | async as viewState">
      <ng-container [ngSwitch]="viewState.status">
        <div class="detail-card" *ngSwitchCase="'idle'">
          <h2 class="detail-title">Search the map</h2>
          <div class="detail-meta">
            <span>Move the map to set a search area.</span>
            <span>Click "Search this area" to load results.</span>
          </div>
        </div>
        <div class="detail-card" *ngSwitchCase="'loading'">
          <h2 class="detail-title">Searching...</h2>
          <div class="detail-meta">
            <span>Fetching zones for the current map view.</span>
          </div>
        </div>
        <div class="detail-card" *ngSwitchCase="'error'">
          <h2 class="detail-title">Search failed</h2>
          <div class="detail-meta">
            <span>{{ viewState.message ?? "Unable to load results." }}</span>
          </div>
        </div>
        <ng-container *ngSwitchCase="'loaded'">
          <div class="detail-card">
            <div class="detail-meta">
              <span>{{ viewState.total }} zones found</span>
              <span>Showing {{ viewState.rows.length }} results</span>
            </div>
          </div>
          <app-travel-options-panel
            [travelEnabled]="travelEnabled"
            [destinationInput]="destinationInput"
            [destinationSuggestions]="(destinationSuggestions$ | async) ?? []"
            [suggestionIndex]="suggestionIndex"
            [travelMode]="travelMode"
            [travelDay]="travelDay"
            [travelTime]="travelTime"
            [dayOptions]="dayOptions"
            [timeOptions]="timeOptions"
            [travelError]="travelError"
            [isSuggesting]="(isDestinationSuggesting$ | async) === true"
            [isGeocoding]="isGeocoding"
            [resolvedDestinationLabel]="resolvedDestinationLabel"
            [travelStatus]="viewState.travelStatus"
            [travelMessage]="viewState.travelMessage"
            (travelEnabledChange)="onTravelEnabledChange($event)"
            (destinationInputChange)="onDestinationInputChange($event)"
            (destinationKey)="onDestinationKey($event)"
            (candidateSelected)="selectCandidate($event)"
            (modeChange)="onTravelModeChange($event)"
            (dayChange)="onTravelDayChange($event)"
            (timeChange)="onTravelTimeChange($event)"
            (applyTravel)="applyTravelOptions()"
          ></app-travel-options-panel>
          <div class="detail-card" *ngIf="viewState.rows.length > 0; else noResults">
            <app-results-table
              [rows]="viewState.rows"
              [travelStatus]="viewState.travelStatus"
              (rowSelected)="selectZone($event)"
            ></app-results-table>
          </div>
          <ng-template #noResults>
            <div class="detail-card">
              <div class="detail-meta">
                <span>No zones found for this area.</span>
              </div>
            </div>
          </ng-template>
        </ng-container>
      </ng-container>
    </section>
    <app-city-details-panel
      [state]="detailsState$ | async"
      [routeState]="routeState$ | async"
    ></app-city-details-panel>
  </aside>
</div>
